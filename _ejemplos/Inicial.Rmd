############################################################################### 
###############################################################################
# flujo_HEM.R
# Flujo Ãºnico para cuantificar la riqueza y distribuciÃ³n de hongos
# ectomicorrÃ­zicos comestibles (HEM) en MÃ©xico, usando repositorios UNAM, GBIF,
# CONABIO y la capa de vegetaciÃ³n (CONABIO 2018).                          â”‚
# Cada lÃ­nea contiene un comentario sobre su funciÃ³n.                       â”‚
###############################################################################

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 0. Dependencias â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## Instale la siguiente secciÃ³n una sola vez, luego comÃ©ntela si lo desea.
# install.packages(c("tidyverse","readxl","rgbif","sf","tmap",
#                    "leaflet","janitor","here","patchwork","DT")) # InstalaciÃ³n base
# if (!requireNamespace("devtools", quietly = TRUE)) install.packages("devtools") # Devtools
# devtools::install_github("brendanf/FUNGuildR") # Instala FUNGuildR desde GitHub

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Carga de librerÃ­as â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(tidyverse)        # Conjunto principal para manipulaciÃ³n de datos ğŸ—ƒï¸
library(readxl)           # Leer archivos Excel (.xlsx) ğŸ“‘
library(rgbif)            # Consultar la API de GBIF ğŸŒ
library(sf)               # Manejo de datos espaciales (simple features) ğŸ—ºï¸
library(FUNGuildR)        # Asignar guilds ecolÃ³gicos a hongos ğŸ„
library(tmap)             # Mapas estÃ¡ticos y coroplÃ©ticos ğŸ–¼ï¸
library(leaflet)          # Mapas interactivos JavaScript ğŸŒ
library(janitor)          # Limpieza rÃ¡pida de nombres de columnas âœ¨
library(here)             # Manejo robusto de rutas relativas ğŸ“‚
library(patchwork)        # Combinar grÃ¡ficos ggplot2 ğŸ§©
library(DT)               # Tablas interactivas en HTML ğŸ“Š
options(tidyverse.quiet = TRUE, stringsAsFactors = FALSE) # Suprime avisos y evita factores

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Importar y depurar lista UNAM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
unam_raw <- read_csv("ListaUNAM.csv", locale = locale(encoding = "latin1"))
unam <- unam_raw %>%                         # Inicia flujo de depuraciÃ³n
  clean_names() %>%                          # Convierte encabezados a snake_case
  mutate(especie = str_trim(especie)) %>%    # Quita espacios extra en nombres
  distinct(especie, .keep_all = TRUE)        # Elimina duplicados exactos
vector_especies <- unam$especie              # Vector con 428 nombres para bÃºsquedas

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Descarga de registros GBIF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
king_key <- name_backbone(name = "Fungi")$kingdomKey              # Obtiene clave 'Fungi'
gbif_raw <- occ_search(                                           # Consulta GBIF
  scientificName = vector_especies,                               # Lista de nombres
  kingdomKey     = king_key,                                      # Restringe a hongos
  country        = "MX",                                          # MÃ©xico
  hasCoordinate  = TRUE,                                          # Solo registros con coordenadas
  limit          = 50000                                          # MÃ¡ximo de registros a bajar
)$data                                                             # Devuelve tabla resultado
gbif_occ <- gbif_raw %>%                                          # Prepara tabla
  select(species, decimalLongitude, decimalLatitude) %>%          # Mantiene columnas clave
  drop_na()                                                       # Filtra filas sin coordenadas

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. Registros CONABIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
conabio_raw <- read_csv(here("datos","CONABIO_hongos_registros.csv"),
                        show_col_types = FALSE)                   # Lee CSV CONABIO
conabio_occ <- conabio_raw %>%                                    # Depura tabla
  clean_names() %>%                                               # Encabezados limpios
  rename(species = scientificname) %>%                            # Renombra columna especie
  mutate(species = str_trim(species)) %>%                         # Elimina espacios
  filter(species %in% vector_especies) %>%                        # Conserva solo comestibles
  select(species, decimallongitude, decimallatitude) %>%          # Selecciona coords
  drop_na() %>%                                                   # Elimina coordenadas vacÃ­as
  rename(decimalLongitude = decimallongitude,                     # Normaliza nombres
         decimalLatitude  = decimallatitude)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. ConversiÃ³n a objetos espaciales (sf) y etiqueta de fuente â”€â”€
gbif_sf <- gbif_occ %>%                                           # Toma tabla GBIF
  mutate(fuente = "GBIF") %>%                                     # AÃ±ade etiqueta fuente
  st_as_sf(coords = c("decimalLongitude","decimalLatitude"), crs = 4326) # A sf
conabio_sf <- conabio_occ %>%                                     # Toma tabla CONABIO
  mutate(fuente = "CONABIO") %>%                                  # Etiqueta fuente
  st_as_sf(coords = c("decimalLongitude","decimalLatitude"), crs = 4326) # A sf

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. Asignar guilds fÃºngicos con FUNGuildR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
guild_total <- funguild_assign(vector_especies)                   # Clasifica lista completa
ecto_total <- guild_total %>%                                     # Filtra ectomicorrÃ­zicos
  filter(guild == "Ectomycorrhizal",
         confidence %in% c("Probable","Highly Probable"))         # Mantiene confianza alta
write_csv(ecto_total, here("salidas","ECTO_total.csv"))           # Exporta CSV total

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7. Cargar shapefile de vegetaciÃ³n de CONABIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
shp_veg <- st_read(here("shp","vegetacion_conabio_2018.shp"),
                   quiet = TRUE)                                  # Capa vegetal nacional

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 8. Intersecar ocurrencias con capa de vegetaciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
gbif_veg    <- st_join(gbif_sf,    shp_veg, join = st_intersects, left = FALSE) # AÃ±ade veg
conabio_veg <- st_join(conabio_sf, shp_veg, join = st_intersects, left = FALSE) # Igual

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ 9. Filtrar ectomicorrÃ­zicos dentro de cada ocurrencia â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ecto_gbif_tot <- gbif_sf    %>% filter(species %in% ecto_total$taxon)           # GBIF sin veg
ecto_cona_tot <- conabio_sf %>% filter(species %in% ecto_total$taxon)           # CONABIO sin veg
ecto_gbif_veg <- gbif_veg   %>% filter(species %in% ecto_total$taxon)           # GBIF con veg
ecto_cona_veg <- conabio_veg%>% filter(species %in% ecto_total$taxon)           # CONABIO con veg
write_csv(st_drop_geometry(ecto_gbif_veg), here("salidas","ECTO_GBIF_veg.csv")) # Exporta
write_csv(st_drop_geometry(ecto_cona_veg), here("salidas","ECTO_CONABIO_veg.csv"))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 10. Conteos por cobertura vegetal y exportaciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tabla_cov <- bind_rows(ecto_gbif_veg, ecto_cona_veg) %>%           # Junta fuentes
  st_set_geometry(NULL) %>%                                        # Elimina geometrÃ­a
  count(nombre_cat, fuente, name = "n") %>%                        # Conteo por tipo y fuente
  arrange(desc(n))                                                 # Orden descendente
write_csv(tabla_cov, here("salidas","registros_por_cobertura.csv"))# Exporta tabla

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 11. Conteo de registros por entidad federativa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
estados <- st_read(here("shp","estados_inegi.shp"), quiet = TRUE)  # Capa estados
gbif_estado <- st_join(ecto_gbif_veg, estados,                    # Une por intersecciÃ³n
                       join = st_intersects, left = FALSE)
tabla_estado <- gbif_estado %>%                                   # Tabla resumen
  st_set_geometry(NULL) %>% 
  count(NOM_ENT, name = "n_registros") %>% 
  arrange(desc(n_registros))
write_csv(tabla_estado, here("salidas","registros_por_estado.csv"))# Exporta tabla

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 12. GrÃ¡ficos de barras comparativos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
gg_cov <- tabla_cov %>%                                            # Prepara datos
  ggplot(aes(reorder(nombre_cat, n), n, fill = fuente)) +          # Mapea ejes
  geom_col(position = "dodge") +                                   # Barras lado a lado
  coord_flip() +                                                   # Voltea ejes
  labs(x = NULL, y = "Registros", fill = "Fuente",
       title = "Hongos ectomicorrÃ­zicos comestibles por cobertura")+
  scale_fill_manual(values = c("GBIF" = "steelblue4",
                               "CONABIO" = "grey50")) +            # Colores propios
  theme_minimal(base_size = 10)                                    # Tema limpio
ggsave(here("salidas","barra_cobertura.png"), gg_cov,
       width = 7, height = 4, dpi = 300)                           # Guarda grÃ¡fico

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 13. Mapa estÃ¡tico tmap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tmap_mode("plot")                                                  # Modo estÃ¡tico
map_ecto <- tm_shape(shp_veg) +                                    # Dibuja vegetaciÃ³n
  tm_polygons(col = "lightgrey", border.alpha = 0.2) +             # Color fondo
  tm_shape(ecto_gbif_veg) +                                        # AÃ±ade puntos GBIF
  tm_dots(col = "darkred", size = 0.03) +                          # Configura puntos
  tm_layout(title = "Registros GBIF de HEM ectomicorrÃ­zicos")      # TÃ­tulo
tmap_save(map_ecto, here("salidas","mapa_ectom_gbif.png"), dpi = 300)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 14. Mapa interactivo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
leaflet() %>%                                                      # Inicia leaflet
  addProviderTiles(providers$CartoDB.Positron) %>%                 # Capa base
  addPolygons(data = shp_veg, color = "#228B22",                   # VegetaciÃ³n
              fillOpacity = 0.25, weight = 0.3, group = "VegetaciÃ³n") %>% 
  addCircleMarkers(data = ecto_gbif_tot,                           # Puntos GBIF
                   radius = 3, color = "red", stroke = FALSE,
                   label = ~species, group = "Registros") %>% 
  addLayersControl(overlayGroups = c("VegetaciÃ³n","Registros"),    # Control capas
                   options = layersControlOptions(collapsed = FALSE)) %>% 
  htmlwidgets::saveWidget(file = here("salidas","mapa_interactivo.html")) # Guarda html

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 15. Tabla interactiva DT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
datatable(tabla_cov,                                              # Crea tabla
          caption = "Registros ectomicorrÃ­zicos por cobertura y fuente",
          options = list(pageLength = 10, scrollX = TRUE)) %>% 
  htmlwidgets::saveWidget(file = here("salidas","tabla_interactiva.html")) # Exporta
